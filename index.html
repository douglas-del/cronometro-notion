<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronômetro Notion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; }
        .notion-app-container { background-color: #191919; border: 0px solid #3a3a3a; position: relative; }
        .notion-input, .notion-select { background-color: #373737; border: 1px solid #4a4a4a; color: #e0e0e0; }
        .notion-button-primary { background-color: #1473e6; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
    </style>
</head>
<body class="p-4">

    <main class="w-full max-w-lg mx-auto notion-app-container rounded-lg p-6 space-y-6">
        
        <div class="text-center">
            <h1 class="text-2xl font-bold text-white">Cronômetro Notion</h1>
            <div id="loadingState" class="text-sm text-yellow-400 mt-2 flex items-center justify-center gap-2">
                <i class="fas fa-sync-alt fa-spin"></i>
                <span>Conectando ao Notion...</span>
            </div>
            <div id="errorState" class="text-sm text-red-500 mt-2 hidden"></div>
        </div>

        <!-- Conteúdo Principal do App -->
        <div id="mainApp" class="hidden">
            <!-- Seção do Cronômetro -->
            <div id="taskSelector" class="space-y-3">
                <div>
                    <label for="clientSelect" class="block text-sm font-medium text-gray-300 mb-1">Cliente</label>
                    <select id="clientSelect" class="w-full p-2 notion-select rounded-md"></select>
                </div>
                <div>
                    <label for="demandSelect" class="block text-sm font-medium text-gray-300 mb-1">Demanda</label>
                    <div class="flex gap-2">
                        <select id="demandSelect" class="w-full p-2 notion-select rounded-md"></select>
                        <button id="newDemandBtn" class="p-2 bg-gray-600 rounded-md hover:bg-gray-500" title="Nova Demanda">
                            <i class="fas fa-plus text-white"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="timerControls" class="text-center space-y-4 mt-4">
                <p id="timerDisplay" class="text-5xl font-bold text-white tabular-nums">00:00:00</p>
                <button id="toggleButton" class="w-full px-6 py-3 notion-button-primary text-white font-semibold rounded-md">
                    <i class="fas fa-play mr-2"></i>
                    <span>Iniciar</span>
                </button>
            </div>

            <!-- Seção de Relatórios -->
            <div class="border-t border-gray-700 mt-6 pt-6">
                <h2 class="text-lg font-bold text-white mb-3 text-center">Relatório Semanal</h2>
                <div class="space-y-3">
                     <div>
                        <label for="reportClientSelect" class="block text-sm font-medium text-gray-300 mb-1">Selecione o Cliente para o Relatório</label>
                        <select id="reportClientSelect" class="w-full p-2 notion-select rounded-md"></select>
                    </div>
                    <button id="generateReportBtn" class="w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-md">
                        <i class="fas fa-file-excel mr-2"></i>
                        <span>Gerar e Atualizar Planilha</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Nova Demanda -->
    <div id="newDemandModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-xl font-bold text-white text-center">Criar Nova Demanda</h3>
            <div>
                <label for="newDemandClientSelect" class="block text-sm font-medium text-gray-300 mb-1">Associar ao Cliente:</label>
                <select id="newDemandClientSelect" class="w-full p-2 notion-select rounded-md"></select>
            </div>
             <div>
                <label for="newDemandName" class="block text-sm font-medium text-gray-300 mb-1">Nome da Nova Demanda:</label>
                <input type="text" id="newDemandName" class="w-full p-2 notion-input rounded-md">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('newDemandModal')" class="px-4 py-2 bg-gray-600 text-white rounded-md">Cancelar</button>
                <button id="saveDemandButton" class="px-4 py-2 notion-button-primary text-white rounded-md">Criar Demanda</button>
            </div>
        </div>
    </div>

    <!-- Modal de Erro Aprimorado -->
    <div id="errorModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 relative">
            <button onclick="closeModal('errorModal')" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
                <h3 class="text-xl font-bold text-white">Ocorreu um Erro</h3>
                <p id="errorMessage" class="text-gray-300 mt-2"></p>
            </div>
        </div>
    </div>

     <!-- Modal de Sucesso do Relatório -->
    <div id="successModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 relative">
             <button onclick="closeModal('successModal')" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-center">
                <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                <h3 class="text-xl font-bold text-white">Sucesso!</h3>
                <p class="text-gray-300 mt-2">A planilha foi atualizada com sucesso.</p>
                <div class="mt-4">
                    <a id="goToSheetBtn" href="#" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Ir para Planilha</a>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ===================================================================================
    // CONFIGURAÇÃO
    // ===================================================================================
    const API_BASE_URL = "https://cronometro-notion-backend.onrender.com";

    // ===================================================================================
    // LÓGICA DO APLICATIVO
    // ===================================================================================
    
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const mainApp = document.getElementById('mainApp');
    const clientSelect = document.getElementById('clientSelect');
    const demandSelect = document.getElementById('demandSelect');
    const newDemandBtn = document.getElementById('newDemandBtn');
    const toggleButton = document.getElementById('toggleButton');
    const timerDisplay = document.getElementById('timerDisplay');
    const reportClientSelect = document.getElementById('reportClientSelect');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const newDemandModal = document.getElementById('newDemandModal');
    const newDemandClientSelect = document.getElementById('newDemandClientSelect');
    const newDemandName = document.getElementById('newDemandName');
    const saveDemandButton = document.getElementById('saveDemandButton');
    const errorModal = document.getElementById('errorModal');
    const errorMessage = document.getElementById('errorMessage');
    const successModal = document.getElementById('successModal');
    const goToSheetBtn = document.getElementById('goToSheetBtn');

    function showError(message) {
        errorMessage.textContent = message;
        openModal('errorModal');
    }

    let appState = {
        clients: [],
        demands: [],
        isTimerRunning: false,
        startTime: null,
        timerInterval: null,
        selectedDemandId: null,
    };

    const api = {
        async getClients() {
            const response = await fetch(`${API_BASE_URL}/api/clients`);
            if (!response.ok) throw new Error('Falha ao buscar clientes.');
            return response.json();
        },
        async getDemands() {
            const response = await fetch(`${API_BASE_URL}/api/demands`);
            if (!response.ok) throw new Error('Falha ao buscar demandas.');
            return response.json();
        },
        async createDemand(clientId, demandName) {
            const response = await fetch(`${API_BASE_URL}/api/demands`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientId, demandName })
            });
            if (!response.ok) throw new Error('Falha ao criar demanda.');
            return response.json();
        },
        async createTimeEntry(demandId, durationSeconds) {
            const response = await fetch(`${API_BASE_URL}/api/time-entries`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ demandId, durationSeconds })
            });
             if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Falha ao criar registro de tempo.');
            }
            return response.json();
        },
        async generateReport(clientId, clientName) {
            const btn = generateReportBtn;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-sync-alt fa-spin mr-2"></i><span>Gerando...</span>`;
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId, clientName })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Falha ao gerar relatório.');
                }
                const result = await response.json();
                goToSheetBtn.href = result.sheetUrl;
                openModal('successModal');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-file-excel mr-2"></i><span>Gerar e Atualizar Planilha</span>`;
            }
        }
    };
    
    function populateSelect(selectElement, items, defaultOption) {
        selectElement.innerHTML = `<option value="">${defaultOption}</option>`;
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            selectElement.appendChild(option);
        });
    }

    function filterDemandsByClient(clientId) {
        const filteredDemands = clientId ? appState.demands.filter(d => d.clientId === clientId) : [];
        populateSelect(demandSelect, filteredDemands, 'Selecione uma demanda');
    }

    const formatTime = (ms) => {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (totalSeconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    };

    function startTimerDisplay() {
        if (appState.timerInterval) clearInterval(appState.timerInterval);
        appState.timerInterval = setInterval(() => {
            const elapsed = Date.now() - appState.startTime;
            timerDisplay.textContent = formatTime(elapsed);
        }, 1000);
    }

    function toggleTimer() {
        if (appState.isTimerRunning) {
            // Parando o cronômetro
            clearInterval(appState.timerInterval);
            const endTime = Date.now();
            const durationSeconds = Math.round((endTime - appState.startTime) / 1000);
            
            api.createTimeEntry(appState.selectedDemandId, durationSeconds)
                .then(response => {
                    console.log('Registro criado com sucesso!', response);
                    
                    localStorage.removeItem('timerStartTime');
                    localStorage.removeItem('timerActiveDemandId');
                    
                    appState.isTimerRunning = false;
                    toggleButton.innerHTML = `<i class="fas fa-play mr-2"></i><span>Iniciar</span>`;
                    toggleButton.classList.remove('bg-red-600');
                    timerDisplay.textContent = '00:00:00';
                    clientSelect.disabled = false;
                    demandSelect.disabled = false;
                })
                .catch(err => {
                    console.error('Erro ao criar registro:', err);
                    showError(`Falha ao registrar o tempo. Verifique sua conexão ou tente novamente. Seu tempo não foi perdido.`);
                });

        } else {
            // Iniciando o cronômetro
            const selectedDemandId = demandSelect.value;
            if (!selectedDemandId) {
                showError('Por favor, selecione uma demanda para iniciar.');
                return;
            }
            appState.selectedDemandId = selectedDemandId;
            appState.isTimerRunning = true;
            appState.startTime = Date.now();
            
            localStorage.setItem('timerStartTime', appState.startTime);
            localStorage.setItem('timerActiveDemandId', appState.selectedDemandId);
            
            startTimerDisplay();

            toggleButton.innerHTML = `<i class="fas fa-stop mr-2"></i><span>Parar</span>`;
            toggleButton.classList.add('bg-red-600');
            clientSelect.disabled = true;
            demandSelect.disabled = true;
        }
    }
    
    function openModal(modalId) { 
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');
    }
    function closeModal(modalId) { 
        const modal = document.getElementById(modalId);
        modal.classList.add('hidden');
    }

    async function initializeApp() {
        try {
            const [clients, demands] = await Promise.all([api.getClients(), api.getDemands()]);
            appState.clients = clients;
            appState.demands = demands;

            populateSelect(clientSelect, appState.clients, 'Selecione um cliente');
            populateSelect(reportClientSelect, appState.clients, 'Selecione um cliente');
            populateSelect(newDemandClientSelect, appState.clients, 'Selecione...');
            
            const savedStartTime = localStorage.getItem('timerStartTime');
            const savedDemandId = localStorage.getItem('timerActiveDemandId');

            if (savedStartTime && savedDemandId) {
                appState.isTimerRunning = true;
                appState.startTime = parseInt(savedStartTime, 10);
                appState.selectedDemandId = savedDemandId;

                const activeDemand = appState.demands.find(d => d.id === savedDemandId);
                if (activeDemand) {
                    clientSelect.value = activeDemand.clientId;
                    filterDemandsByClient(activeDemand.clientId);
                    demandSelect.value = savedDemandId;
                }

                toggleButton.innerHTML = `<i class="fas fa-stop mr-2"></i><span>Parar</span>`;
                toggleButton.classList.add('bg-red-600');
                clientSelect.disabled = true;
                demandSelect.disabled = true;
                startTimerDisplay();
            }
            
            loadingState.classList.add('hidden');
            mainApp.classList.remove('hidden');

        } catch (error) {
            console.error("Erro ao inicializar:", error);
            loadingState.classList.add('hidden');
            errorState.textContent = `Erro ao conectar: ${error.message}`;
            errorState.classList.remove('hidden');
        }
    }

    clientSelect.addEventListener('change', (e) => filterDemandsByClient(e.target.value));
    toggleButton.addEventListener('click', toggleTimer);
    newDemandBtn.addEventListener('click', () => openModal('newDemandModal'));
    saveDemandButton.addEventListener('click', async () => {
        const clientId = newDemandClientSelect.value;
        const demandName = newDemandName.value.trim();
        if (!clientId || !demandName) {
            showError('Preencha todos os campos para criar a demanda.');
            return;
        }
        try {
            const newDemand = await api.createDemand(clientId, demandName);
            appState.demands.push(newDemand);
            const currentClient = clientSelect.value;
            filterDemandsByClient(currentClient);
            if (clientId === currentClient) {
                demandSelect.value = newDemand.id;
            }
            closeModal('newDemandModal');
        } catch (error) {
            showError(`Erro ao criar demanda: ${error.message}`);
        }
    });

    generateReportBtn.addEventListener('click', () => {
        const clientId = reportClientSelect.value;
        if (!clientId) {
            showError('Por favor, selecione um cliente para gerar o relatório.');
            return;
        }
        const clientName = reportClientSelect.options[reportClientSelect.selectedIndex].text;
        api.generateReport(clientId, clientName).catch(err => showError(err.message));
    });

    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

